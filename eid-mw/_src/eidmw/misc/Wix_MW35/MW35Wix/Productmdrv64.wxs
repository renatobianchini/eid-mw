<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:difx="http://schemas.microsoft.com/wix/DifxAppExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <?include ..\..\..\svn_revision.wxs ?>

  <?define var.OfficialProductVersion =4.0.4?>
  <?define var.ProductVersion =4.0.$(var.RevisionNumber)?>
  <?define var.FullProductVersion =$(var.OfficialProductVersion).$(var.RevisionNumber)?>

  <?define var.UpgradeCode ={B9E9D33B-9CC0-4c34-B646-3B5CC919F9A8}?>
  <?define var.ProductGuid ={F411208F-DAE7-4a68-9718-6EB8B6B4E199}?>
  <!--<?define var.ProductGuid ={824563DE-75AD-4166-9DC0-B6482F2DED5A})?>-->
  <?define var.ProductName =Belgium e-ID minidriver $(var.OfficialProductVersion) (build $(var.RevisionNumber))?>

  <?define var.PackageCode="*"?>

  <Product Id="$(var.ProductGuid)"
           Name="$(var.ProductName)"
           Language="!(loc.Lang)"
           Codepage="1252"
           Version="$(var.ProductVersion)"
           Manufacturer="Belgian Government"
           UpgradeCode="$(var.UpgradeCode)">

    <!-- InstallerVersion="300" Released with Windows XP with Service Pack 2 (SP2) -->
    <Package Id="$(var.PackageCode)"
             InstallerVersion="300"
             Keywords="Belgium e-ID Middleware Installer"
             Platform="x64"
             Manufacturer="Belgian Government"
             Compressed="yes"
             InstallPrivileges="elevated"
    />

    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion Minimum="$(var.ProductVersion)"
                      IncludeMinimum="no"
                      OnlyDetect="yes"
                      Property="NEWPRODUCTFOUND"
      />
      <UpgradeVersion Minimum="4.0.0"
                      IncludeMinimum="yes"
                      Maximum="$(var.ProductVersion)"
                      IncludeMaximum="no"
                      Property="UPGRADEFOUND"
      />
    </Upgrade>

    <WixVariable Id="WixUIBannerBmp" Value="..\..\..\misc\Wix_MW35\bannrbmp.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="..\..\..\misc\Wix_MW35\dlgbmp.bmp" />

    <Condition Message="!(loc.MinOs)">
      <![CDATA[
      Installed
      OR ((VersionNT = 500) and (ServicePackLevel > 3))
      OR ((VersionNT = 501) and (ServicePackLevel > 1))
      OR (VersionNT > 501)
      ]]>
    </Condition>

    <Media Id="1" Cabinet="Minidriver64.cab" EmbedCab="yes" />

    <Icon Id="eid.ico" SourceFile="..\..\..\eidgui\eid.ico"/>

    <Property Id="ARPPRODUCTICON" Value="eid.ico" />
    <Property Id="ARPURLINFOABOUT" Value="http://eid.belgium.be"/>

    <Property Id="ALLUSERS" Value="1" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder" Name="ProgramFilesFolder">
        <Directory Id="APPLICATIONROOTFOLDER" Name="Belgium Identity Card">
          <Directory Id="MINIDRIVERROOTFOLDER" Name="BeID Minidriver"/>
        </Directory>
      </Directory>

      <Directory Id="SystemFolder" Name="SystemFolder"/>
      <Directory Id="System64Folder" Name="System64Folder"/>
    </Directory>

    <DirectoryRef Id="MINIDRIVERROOTFOLDER">
      <Component Id="beidmdrv" Guid="2bdf2bb0-4f7a-4ed6-a3d4-abcbe212fa14" Win64="no">
        <File Id="beidmdrv.inf" Name="beidmdrv.inf" Source="..\..\..\minidriver\makemsi\Release\beidmdrv.inf" KeyPath="yes" DiskId="1" />
        <File Id="beidmdrv.cat" Name="beidmdrv.cat" Source="..\..\..\minidriver\makemsi\Release\beidmdrv.cat" KeyPath="no" DiskId="1" />
        <File Id="beidmdrv32.dll" Name="beidmdrv32.dll" Source="..\..\..\minidriver\makemsi\Release\beidmdrv32.dll" KeyPath="no" DiskId="1" />
        <File Id="beidmdrv64.dll" Name="beidmdrv64.dll" Source="..\..\..\minidriver\makemsi\Release\beidmdrv64.dll" KeyPath="no" DiskId="1" />
        <difx:Driver ForceInstall="no" PlugAndPlayPrompt="no" DeleteFiles="yes" />
      </Component>
      <!-- Certificate Propagation Service is a standard Windows service available in from Windows Vista on. In order to use the minidriver
			   it is necessary that this service is running. When a smart card reader is inserted this service should be started  by the smart card
			   driver. As not all drivers are following this guidance, we start CertPropSvc during the minidriver install -->
      <Component Id="CertPropService" Guid="932459d0-df59-11de-8a39-0800200c9a66" Permanent="yes" Win64="no">
        <!-- Start Certificate Propagation Service during startup -->
        <RegistryValue Root="HKLM" Key="System\CurrentControlSet\Services\CertPropSvc" Type="integer" Name="Start" Value="2" KeyPath="yes"/>
        <!-- Start Certificate Propagation Service now -->
        <!--<ServiceControl Id="StartCertPropSvc" Name="CertPropSvc" Start="install" />-->
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="System64Folder">
      <Component Id="MINIDRIVER_64" Guid="{a8259480-e408-11de-8a39-0800200c9a66}" SharedDllRefCount="no" Win64="yes">
        <File Id="MINIDRIVER_64.dll" Name="beidmdrv64.dll" KeyPath="yes" Source="..\..\..\minidriver\makemsi\Release\beidmdrv64.dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SystemFolder">
      <Component Id="MINIDRIVER" Guid="{2A6887B1-A020-47e7-847A-F68673A12CE2}" SharedDllRefCount="yes" Win64="no">
        <File Id="MINIDRIVER.dll" Name="beidmdrv32.dll" KeyPath="yes" Source="..\..\..\minidriver\makemsi\Release\beidmdrv32.dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="TARGETDIR">
      <Component Id="REGISTERMINIDRIVER" Guid="{B9980C19-883E-49f9-BDD2-AB3D75187C8F}" Win64="no">
        <RegistryKey Root="HKLM"
                     Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\Beid"
                     Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="80000001" Value="beidmdrv32.dll" KeyPath="yes"/>
          <RegistryValue Type="binary" Name="ATR" Value="3b98004000a503010101ad1300" KeyPath="no"/>
          <RegistryValue Type="binary" Name="ATRMask" Value="ffff00ff00ffffffffffffff00" KeyPath="no"/>
          <RegistryValue Type="string" Name="Crypto Provider" Value="Microsoft Base Smart Card Crypto Provider" KeyPath="no"/>
          <RegistryValue Type="string" Name="Smart Card Key Storage Provider" Value="Microsoft Smart Card Key Storage Provider" KeyPath="no"/>
          <RegistryValue Type="string" Name="80000100" Value="en-US,Please enter your PIN;en-EN,Please enter your PIN;nl-BE,Geef uw PIN in;nl-NL,Geef uw PIN in;fr-BE,Entrez votre code PIN;fr-FR,Entrez votre code PIN;de-DE,Bitte geben Sie Ihre PIN ein" KeyPath="no"/>
          <RegistryValue Type="string" Name="80000103" Value="en-US,Please enter your PIN;en-EN,Please enter your PIN;nl-BE,Geef uw PIN in;nl-NL,Geef uw PIN in;fr-BE,Entrez votre code PIN;fr-FR,Entrez votre code PIN;de-DE,Bitte geben Sie Ihre PIN ein" KeyPath="no"/>
        </RegistryKey>
      </Component>

      <Component Id="REGISTERMINIDRIVER_64" Guid="{3BCA1B2C-08AF-4727-AD85-1C60025656EA}" Win64="yes">
        <RegistryKey Root="HKLM"
          Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\Beid"
          Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="80000001" Value="beidmdrv64.dll" KeyPath="yes"/>
          <RegistryValue Type="binary" Name="ATR" Value="3b98004000a503010101ad1300" KeyPath="no"/>
          <RegistryValue Type="binary" Name="ATRMask" Value="ffff00ff00ffffffffffffff00" KeyPath="no"/>
          <RegistryValue Type="string" Name="Crypto Provider" Value="Microsoft Base Smart Card Crypto Provider" KeyPath="no"/>
          <RegistryValue Type="string" Name="Smart Card Key Storage Provider" Value="Microsoft Smart Card Key Storage Provider" KeyPath="no"/>
          <RegistryValue Type="string" Name="80000100" Value="en-US,Please enter your PIN;en-EN,Please enter your PIN;nl-BE,Geef uw PIN in;nl-NL,Geef uw PIN in;fr-BE,Entrez votre code PIN;fr-FR,Entrez votre code PIN;de-DE,Bitte geben Sie Ihre PIN ein" KeyPath="no"/>
          <RegistryValue Type="string" Name="80000103" Value="en-US,Please enter your PIN;en-EN,Please enter your PIN;nl-BE,Geef uw PIN in;nl-NL,Geef uw PIN in;fr-BE,Entrez votre code PIN;fr-FR,Entrez votre code PIN;de-DE,Bitte geben Sie Ihre PIN ein" KeyPath="no"/>
        </RegistryKey>
      </Component>
    </DirectoryRef>


      <Feature Id="Minidriver"
                  Title="eID Minidriver"
                  Description="eID Minidriver"
                  Level="1"
                >
        <!-- Shortcuts -->
        <Feature Id="Install_Minidriver" Level="0" Display="hidden" Absent="disallow">
          <ComponentRef Id="beidmdrv"/>
          <ComponentRef Id="CertPropService"/>
          <ComponentRef Id="MINIDRIVER"/>
          <ComponentRef Id="MINIDRIVER_64"/>
          <ComponentRef Id="REGISTERMINIDRIVER"/>
          <ComponentRef Id="REGISTERMINIDRIVER_64"/>
          <Condition Level="1">VersionNT >= 600</Condition>
        </Feature>
      </Feature>
 

    <!--SetARPINSTALLLOCATION sets the location in the registry entries of the Add & Remove Panel-->
    <CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[APPLICATIONROOTFOLDER]" />
    <CustomAction Id="IsPrivileged" Error="!(loc.AdminNeeded)" />

    <InstallExecuteSequence>
      <Custom Action="IsPrivileged" Before="LaunchConditions">Not Privileged</Custom>
      <Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>
      <RemoveExistingProducts After="InstallExecute" />
      <ScheduleReboot After="InstallFinalize">NOT Installed</ScheduleReboot>     
    </InstallExecuteSequence>

  </Product>
</Wix>
